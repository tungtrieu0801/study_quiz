name: Deploy Study Quiz FE

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout source
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Setup Node
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # 3. Install & Build React/Vite
      - name: Install and build
        run: |
          npm install
          npm run build

      # 4. Tạo archive để upload
      - name: Prepare artifact
        run: |
          cd dist
          tar -czf ../dist.tar.gz .
          cd ..

      # 5. Upload build lên VPS
      - name: Upload FE to VPS
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "dist.tar.gz"
          target: "/opt/study_quiz_fe"

      # 6. SSH vào VPS, extract & deploy atomic
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            cd /opt/study_quiz_fe

            VERSION=$(date +"%Y%m%d%H%M%S")
            RELEASE_DIR="releases/$VERSION"

            echo "Tạo release mới: $RELEASE_DIR"
            mkdir -p $RELEASE_DIR
            tar -xzf dist.tar.gz -C $RELEASE_DIR
            rm dist.tar.gz

            echo "Cập nhật symlink → chạy bản mới"
            ln -sfn $RELEASE_DIR current

            echo "Reload NGINX"
            sudo systemctl reload nginx

            echo "Xong!"
